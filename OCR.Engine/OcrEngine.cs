using SimpleLPR2;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace OCR.Engine
{
    public class OcrEngine
    {
        private readonly ISimpleLPR _lpr = SimpleLPR.Setup();

        public OcrEngine()
        {
            byte[] key = new byte[] { 60, 63, 120, 109, 108, 32, 118, 101, 114, 115, 105, 111, 110, 61, 34, 49, 46, 48, 34, 32, 101, 110, 99, 111, 100, 105, 110, 103, 61, 34, 85, 84, 70, 45, 56, 34, 63, 62, 13, 10, 60, 108, 105, 99, 101, 110, 115, 101, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 80, 82, 79, 68, 85, 67, 84, 34, 32, 118, 61, 34, 83, 105, 109, 112, 108, 101, 76, 80, 82, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 67, 73, 84, 89, 34, 32, 118, 61, 34, 73, 115, 116, 97, 110, 98, 117, 108, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 67, 79, 77, 80, 65, 78, 89, 34, 32, 118, 61, 34, 73, 78, 78, 79, 32, 84, 69, 75, 78, 79, 76, 79, 74, 73, 32, 69, 108, 101, 107, 116, 114, 111, 110, 105, 107, 32, 83, 97, 110, 46, 32, 118, 101, 32, 84, 105, 99, 46, 32, 76, 116, 105, 32, 83, 116, 105, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 67, 79, 85, 78, 84, 82, 89, 34, 32, 118, 61, 34, 84, 117, 114, 107, 101, 121, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 69, 77, 65, 73, 76, 34, 32, 118, 61, 34, 101, 114, 100, 101, 109, 64, 105, 110, 110, 111, 116, 101, 107, 110, 111, 108, 111, 106, 105, 46, 99, 111, 109, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 69, 78, 67, 79, 68, 73, 78, 71, 34, 32, 118, 61, 34, 85, 84, 70, 56, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 70, 73, 82, 83, 84, 78, 65, 77, 69, 34, 32, 118, 61, 34, 69, 114, 100, 101, 109, 32, 84, 97, 121, 102, 117, 110, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 73, 83, 79, 95, 67, 79, 68, 69, 34, 32, 118, 61, 34, 84, 82, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 76, 65, 78, 71, 85, 65, 71, 69, 95, 73, 68, 34, 32, 118, 61, 34, 49, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 76, 65, 83, 84, 78, 65, 77, 69, 34, 32, 118, 61, 34, 83, 97, 108, 109, 97, 110, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 78, 76, 65, 76, 76, 79, 87, 34, 32, 118, 61, 34, 78, 79, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 80, 82, 79, 68, 85, 67, 84, 95, 73, 68, 34, 32, 118, 61, 34, 51, 48, 48, 49, 56, 51, 56, 52, 49, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 80, 85, 82, 67, 72, 65, 83, 69, 95, 68, 65, 84, 69, 34, 32, 118, 61, 34, 49, 54, 47, 48, 50, 47, 50, 48, 49, 54, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 80, 85, 82, 67, 72, 65, 83, 69, 95, 73, 68, 34, 32, 118, 61, 34, 53, 48, 54, 49, 55, 56, 49, 49, 51, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 81, 85, 65, 78, 84, 73, 84, 89, 34, 32, 118, 61, 34, 49, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 82, 69, 71, 95, 78, 65, 77, 69, 34, 32, 118, 61, 34, 73, 78, 78, 79, 32, 84, 69, 75, 78, 79, 76, 79, 74, 73, 32, 69, 108, 101, 107, 116, 114, 111, 110, 105, 107, 32, 83, 97, 110, 46, 32, 118, 101, 32, 84, 105, 99, 46, 32, 76, 116, 105, 32, 83, 116, 105, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 82, 85, 78, 78, 73, 78, 71, 95, 78, 79, 34, 32, 118, 61, 34, 49, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 83, 84, 82, 69, 69, 84, 34, 32, 118, 61, 34, 78, 97, 116, 111, 121, 111, 108, 117, 32, 67, 100, 46, 32, 72, 97, 115, 32, 32, 86, 97, 116, 97, 110, 32, 196, 176, 197, 159, 32, 77, 101, 114, 107, 101, 122, 105, 32, 78, 111, 58, 50, 50, 49, 32, 75, 97, 116, 58, 50, 32, 85, 109, 114, 97, 110, 105, 121, 101, 34, 32, 47, 62, 13, 10, 32, 32, 60, 101, 32, 107, 61, 34, 90, 73, 80, 34, 32, 118, 61, 34, 51, 52, 55, 55, 54, 34, 32, 47, 62, 13, 10, 32, 32, 60, 98, 32, 118, 61, 34, 54, 86, 90, 65, 65, 55, 108, 70, 78, 68, 90, 78, 97, 107, 69, 106, 50, 116, 51, 43, 86, 81, 61, 61, 34, 32, 47, 62, 13, 10, 32, 32, 60, 98, 32, 118, 61, 34, 98, 48, 117, 77, 116, 105, 111, 81, 120, 56, 100, 107, 87, 119, 50, 122, 98, 51, 108, 57, 105, 119, 61, 61, 34, 32, 47, 62, 13, 10, 32, 32, 60, 98, 32, 118, 61, 34, 90, 49, 111, 77, 108, 112, 106, 88, 101, 109, 68, 67, 107, 115, 105, 69, 97, 89, 78, 113, 85, 103, 61, 61, 34, 32, 47, 62, 13, 10, 60, 47, 108, 105, 99, 101, 110, 115, 101, 62 };
            _lpr.set_productKey(key);
            _lpr.set_countryWeight("Turkey", 1.0f);
            _lpr.realizeCountryWeights();
        }

        public string DoOcr(string imagePath)
        {
            string plate = "";

            try
            {
                IProcessor proc = _lpr.createProcessor();

                List<Candidate> cds = proc.analyze(imagePath, 50);

                if (cds.Count > 0)
                {
                    foreach (Candidate cd in cds)
                    {
                        plate = cd.text.Trim().Replace(" ", string.Empty);
                    }
                }
            }
            catch (Exception e)
            {
                return "";
            }

            return plate;
        }
    }
}
